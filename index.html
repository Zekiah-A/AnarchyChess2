<!DOCTYPE html>
<html>
<head>
    <title>Anarchy chess</title>
    <meta name="description" content="A massive multiplayer chess game with slightly bent rules. Here be anarchy.">
    <meta name="keywords" content="chess anarchy game multiplayer online">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="resources/logo.ico">
    <script src="./lib/tsparticles.confetti.bundle.min.js"></script>
    <script src="./component-registrar.js"></script>
    <script src="./piece-data.js"></script>
    <script src="./resources.js"></script>
    <script src="./board.js"></script>
    <meta charset="UTF-8">
</head>
<body>
    <p class="copyright-notice">
        If you're seeing this, you probably moved the board offscreen. AnarchyChess, ¬©Zekiah-A
    </p>
    <div id="gamemodeTitle" class="hud" onclick="gamemodesPanel.toggleAttribute('data-closed');">
        <p>AnarchyChess</p>
    </div>
    <div id="gamemodesPanel" class="info-panel" data-closed="">
        <h4 style="margin: 0px;">Match options:</h4>
        <input type="button" value="Request replay">
        <input type="button" value="Exit match">
    </div>
    <div class="hud game-actions">
        <p onclick="chatPanel.toggleAttribute('data-closed'); settingsPanel.setAttribute('data-closed', true);">Chat</p>
        <p onclick="settingsPanel.toggleAttribute('data-closed'); chatPanel.setAttribute('data-closed', true);">Settings</p>
        <p onclick="rulesetPanel.toggleAttribute('data-closed')">Ruleset</p>
    </div>
    <div id="chatPanel" data-closed="true" class="info-panel">
        <div id="chatMessages">
            <p>ü¢Ç Chat messages will appear here</p>
        </div>
        <input type="text" maxlength="250" onkeydown="
            if (event.key == 'Enter') {
                let input = this;
                //sendChatMessage(input.value);
                input.value = '';
            }
        ">
    </div>
    <div id="settingsPanel" data-closed="true" class="info-panel">
        <h4 style="margin: 0px;">Sound effects:</h4>
        <div style="display: flex;flex-direction: column;row-gap: 3px;" onclick="">
            <input type="button" value="Enable sound">
            <input type="button" value="Disable sound">
        </div>
        <h4 style="margin: 0px;">Graphics options:</h4>
        <div style="display: flex;flex-direction: column;row-gap: 3px;" onclick="">
            <input type="button" value="Low graphics">
            <input type="button" value="Medium graphics">
            <input type="button" value="High graphics">
        </div>
    </div>
    <div id="turnPanel" class="info-panel">
        <div id="turnProgress"></div>
        <div id="turnLabel" style="white-space: pre;">Current turn: 1            (5s)</div>
    </div>
    <div id="infoPanel" class="info-panel">
        <p>Zoom: <span id="zoomIndicator">0.4</span>x</p>
        <p>Board: <span id="boardIndicator">0, 0</span></p>
        <p>Position: <span id="tileIndicator">A1</span></p>
    </div>
    <div id="deathMenu" data-closed="true" class="menu">
        <h1 style="margin-bottom: 8px;">‚ôüÔ∏è BLUNDER</h1>
        <p>You were killed by another piece.</p>
        <div class="dual-options">
            <input value="Respawn on map" type="button">
            <input value="Main menu" type="button">
        </div>
    </div>
    <div id="mainMenu" class="main-menu">
        <header id="header" onwheel="
            mainMenu.scrollBy({
                top: event.deltaY,
                left: 0,
                behavior: 'smooth'
            })
        ">
            <div id="headerBranding" class="branding">
                <img src="resources/logo.png" height="64" alt="logo">
                <h1>AnarchyChess</h1>
            </div>
            <nav id="headerNav">
                <a class="novisit page-link" href="#login" data-page="login">Login</a> |
                <a class="novisit page-link" href="#signup" data-page="signup">Sign up</a> |
                <a class="novisit page-link" href="#main" data-page="main">Home</a> |
                <a class="novisit page-link" href="#profile" data-page="profile">My profile</a> |
                <a class="novisit page-link" href="#settings" data-page="settings">Settings</a>
            </nav>
        </header>
        <div style="min-height: 200px;"><!--spacer--></div>
        <div class="main-menu-page" data-page="login">
            <h3 style="margin-top: 0;">Login with AnarchyChess account</h3>
            <div class="form-frame">
                <input type="text" placeholder="Username" oninput="validateUsername(this)">
                <input type="text" placeholder="Email">
                <input type="button" value="Login">
            </div>
            <div>
                <a class="novisit" href="#signup">Create account</a> | <a class="novisit" href="#forgot">Forgot username?</a>
            </div>
        </div>
        <div class="main-menu-page" data-page="signup">
            <h3 style="margin-top: 0;">Sign up to AnarchyChess</h3>
            <div class="form-frame">
                <input type="text" placeholder="Username" oninput="validateUsername(this)">
                <input type="text" placeholder="Email">
                <input type="text" placeholder="Confirm email">
                <input type="button" value="Create account">
            </div>
            <div>
                <a class="novisit" href="#login">Already have an account?</a>
            </div>
        </div>
        <div class="main-menu-page" data-page="main">
            <p style="text-align: center;">A multiplayer chess board, with infinite variations slightly bent rules. Here be anarchy.</p>
            <div id="configurePanel" class="modal" data-closed="true">
                <ul class="modal-title" onclick="if (event.target.nodeName == 'LI') {
                    this.querySelectorAll('li').forEach(element => {
                        element.removeAttribute('selected')
                    })
                    event.target.setAttribute('selected', true)
                    configurePanel.querySelectorAll('.modal-content').forEach(element => element.style.display = 'none')
                    configurePanel.querySelector(`.modal-content[data-page=\x22${event.target.dataset.page}\x22]`).style.display = 'flex'
                }">
                    <li data-selected data-page="ruleset">Ruleset</li>
                    <li data-page="arrangement">Piece arrangement</li>
                </ul>
                <div class="modal-content" data-page="ruleset">
                    <div class="modal-content-container">
                        <ac-ruleset></ac-ruleset>
                        <div class="modal-content-side"></div>
                    </div>
                </div>
                <div class="modal-content" data-page="arrangement" style="display: none;">
                    <div class="modal-content-container">
                        <div class="arrangement-board-container">
                            <span class="arrangement-side-label">Black</span>
                            <ac-board id="arrangementBoard" rows="8" columns="8"></ac-board> 
                            <span class="arrangement-side-label">White</span>
                        </div>
                        <div class="modal-content-side" ondragstart="{const dragged = event.target
                            if (dragged.nodeName == 'IMG') {
                                arrangementCurCol = dragged.dataset.colour
                                arrangementCurType = dragged.dataset.type
                                dragged.style.border = '2px solid var(--ui-special)'
                            }
                        }" ondragend="{const dragged = event.target
                            if (dragged.nodeName == 'IMG') {
                                dragged.style.removeProperty('border')
                            }
                        }">
                            <div class="arrangement-section">Black</div>
                            <div class="arrangement-grid">
                                <img src="resources/pawn-black.svg" data-colour="black" alt="" data-type="pawn">
                                <img src="resources/rook-black.svg" data-colour="black" alt="" data-type="rook">
                                <img src="resources/knight-black.svg" data-colour="black" alt="" data-type="knight">
                                <img src="resources/bishop-black.svg" data-colour="black" alt="" data-type="bishop">
                                <img src="resources/queen-black.svg" data-colour="black" alt="" data-type="queen">
                                <img src="resources/king-black.svg" data-colour="black" alt="" data-type="king">
                            </div>
                            <div class="arrangement-section">White</div>
                            <div class="arrangement-grid">
                                <img src="resources/pawn-white.svg" data-colour="white" alt="" data-type="pawn">
                                <img src="resources/rook-white.svg" data-colour="white" alt="" data-type="rook">
                                <img src="resources/knight-white.svg" data-colour="white" alt="" data-type="knight">
                                <img src="resources/bishop-white.svg" data-colour="white" alt="" data-type="bishop">
                                <img src="resources/queen-white.svg" data-colour="white" alt="" data-type="queen">
                                <img src="resources/king-white.svg" data-colour="white" alt="" data-type="king">
                            </div>
                            <div style="flex-grow: 1;"><!--vertical spacer--></div>
                            <div class="arrangement-button" tabindex="1" onclick="if (arrangementSelC != null && arrangementSelR != null) {
                                const pieceClone = arrangementBoard.pieceElements[arrangementSelC][arrangementSelR].cloneNode(true)
                                arrangementBoard.board.appendChild(pieceClone)
                                pieceClone.style.setProperty('--piece-fill', 'red')
                                pieceClone.animate([
                                    { transform: 'scale(1.8) rotate(10deg)', opacity: 0 },
                                ], {
                                    duration: 1000,
                                    fill: 'forwards',
                                    iterations: 1,
                                })
                                setTimeout(() => pieceClone.remove(), 1000)
                                const canvBounds = arrangementCanvas.getBoundingClientRect()
                                const pieceBounds = pieceClone.getBoundingClientRect()
                                const tileSize = arrangementBoard.getTileSize()
                                arrangementCanvas.confetti({
                                    spread: 360,
                                    gravity: 1,
                                    particleCount: 50,
                                    startVelocity: 10,
                                    shapes: ['text'],
                                    shapeOptions: {
                                        text: {
                                            value: ['üí•', 'üî•', 'üî¥'],
                                        }
                                    },
                                    origin: { x: (pieceBounds.left - canvBounds.left + tileSize / 2) / arrangementCanvas.offsetWidth,
                                        y: (pieceBounds.top - canvBounds.top + tileSize / 2) / arrangementCanvas.offsetHeight },
                                })
                                
                                arrangementBoard.clearPiece(arrangementSelC, arrangementSelR)
                                arrangementSelC = null
                                arrangementSelR = null
                                updateArrangementStats()
                            }">Delete piece üóëÔ∏è</div>
                        </div>
                        <canvas id="arrangementCanvas" style="position: absolute; bottom: 0; left: 0; height: 100%; pointer-events: none; width: 100%;"></canvas>
                    </div>
                        <span id="arrangementStats">Black pieces: 0, White pieces: 0, White king present: ‚ùå, Black king present: ‚ùå</span>
                </div>
            </div>
            <input style="aspect-ratio: 1/1;" value="Create new ruleset" type="button" onclick="configurePanel.removeAttribute('data-closed')">
            <input style="width: 40%;" value="Play" type="button" onclick="mainMenu.style.display = 'none';">
        </div>
        <div class="main-menu-page" data-page="profile">
            <h3 style="margin-top: 0;">Account profile</h3>
            <p>No profile found. Are you sure you're logged in?</p>
            <span><a class="novisit" href="#login">Login</a> | <a class="novisit" href="#signup">Signup</a></span>
        </div>
        <div class="main-menu-page" data-page="settings">
            <h3 style="margin-top: 0;">General settings</h3>

        </div>
    </div>
    <div id="spawnMenu" style="display: none;" class="menu spawn-menu">
        <h2>Choose your spawn location</h2>
        <div class="dual-options">
            <input id="tokenSpawnButton" value="Continue from last location" type="button" onclick="">
            <input value="Random location" type="button" onclick="">
        </div>
    </div>
    <div id="meTurnPopup">It is now your turn!</div>
    <div id="rulesetPanel" class="side-panel" data-closed="true">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0px;">Game rules:</h3>
            <input type="button" value="Close" onclick="rulesetPanel.setAttribute('data-closed', true)">    
        </div>
        <div class="match-rules">
            <h5 style="margin-bottom: 0px;">Game events:</h5>
            <div>
                <span data-kind="keyword">WHEN</span> <span data-layer="0">the game starts</span> <span data-layer="0">it is black's move</span><span>.</span>
            </div>
            <div>
                <span data-kind="keyword">WHEN</span> <span data-layer="0">black's queen is taken</span> <span data-layer="0">white must forfeit<span data-layer="1">a pawn</span></span><span>.</span>
            </div>
            <h5 style="margin-bottom: 0px;">Per move ruleset:</h5>
        </div>
    </div>
<script>
    let arrangementPrevValid = false
    let arrangementCurCol = null
    let arrangementCurType = null
    let arrangementSelC = null
    let arrangementSelR = null
    ;(async function() { // Async initialisers
        arrangementCanvas.confetti = await confetti.create(arrangementCanvas, { resize: true })
    })()

    arrangementBoard.ontilehover = function(e, column, row, tile) {
        tile.classList.add("hilight")
    } 
    arrangementBoard.ontiledrop = function(e, column, row, tile) {
        if (arrangementCurCol === null || arrangementCurType == null) return
        tile.classList.remove("hilight")
        arrangementBoard.setPiece(column, row, new PieceData(arrangementCurType, arrangementCurCol))
        updateArrangementStats()
    }
    arrangementBoard.ontileleave = function(e, column, row, tile) {
        tile.classList.remove("hilight")
    }
    arrangementBoard.onpiececlick = function(e, column, row, piece) {
        if (arrangementSelC != null && arrangementSelR != null) {
            const previousSelected = arrangementBoard.pieceElements[arrangementSelC][arrangementSelR]
            previousSelected?.getAnimations().map(animation => animation.cancel())
        }
        arrangementSelC = column
        arrangementSelR = row
        
        piece.animate([{
            border: "8px solid var(--ui-hilight-transparent)",
            transform: "scale(1.1)",
        },
        ], {
            fill: "forwards",
            duration: 200,
            iterations: 1,
        })
    }
    function getArrangementStats() {
        let whiteKing = false
        let blackKing = false
        let blackCount = 0
        let whiteCount = 0

        for (let c = 0; c < arrangementBoard.columns; c++) {
            for (let r = 0; r < arrangementBoard.rows; r++) {
                const pieceData = arrangementBoard.tiles[c][r]
                if (!pieceData) continue
                if (pieceData.colour === "black") {
                    blackCount++
                    if (pieceData.type === "king") blackKing = true
                }
                else {
                    whiteCount++
                    if (pieceData.type === "king") whiteKing = true
                }
            }
        }

        return { whiteKing, blackKing, blackCount, whiteCount, valid: whiteKing && blackKing && blackCount > 1 && whiteCount > 1 }
    }
    function updateArrangementStats() {
        const stats = getArrangementStats()
        if (stats.valid && !arrangementPrevValid) {
            (async () => {
                arrangementCanvas.confetti({
                    spread: 100,
                    particleCount: 85,
                    startVelocity: 35,
                    origin: { x: 0.35, y: 1 },
                })
            })();
            arrangementStats.animate([
                { transform: "scale(1)" },
                { opacity: 1 },
                { opacity: 0 },
                { transform: "scale(1.2)" },
            ], {
                duration: 1000,
                iterations: 1,
            })
            setTimeout(function() {
                if (getArrangementStats().valid) {
                    arrangementStats.style.opacity = 1
                }
            }, 1000)
        }
        else {
            arrangementStats.style.opacity = 0.6
        }
        arrangementPrevValid = stats.valid
        arrangementStats.innerHTML = `Black pieces: <span style="color:${stats.blackCount > 1 ? 'green' : 'red'}">${
            stats.blackCount}</span>, White pieces: <span style="color:${stats.whiteCount > 1 ? 'green' : 'red'}">${
            stats.whiteCount}</span>, White king present: ${stats.whiteKing ? "‚úÖ" : "‚ùå"}, Black king present: ${
            stats.blackKing ? "‚úÖ" : "‚ùå"}`
    }
    updateArrangementStats()

    function validateUsername(input) {
        input.value = input.value.replace(/\W+/g, '').toLowerCase()
    }

    function lerp(from, to, weight){
        return (1 - weight) * from + weight *to
    }
    let scrollAnim = null
    function calcHeaderPositioning() {        
        const toCollapsed = Math.min(1, mainMenu.scrollTop / 100)
        const headerCentreX = header.offsetWidth / 2
        header.style.boxShadow = `0px 0px ${Math.min(8, mainMenu.scrollTop)}px gray`
        header.style.height = `${Math.max(100, 200 - mainMenu.scrollTop)}px`
        headerBranding.style.left = `${lerp(headerCentreX - headerBranding.offsetWidth / 2, 16, toCollapsed)}px`
        headerBranding.style.scale = lerp(1.2, 0.8, toCollapsed)

        headerNav.style.left = `${lerp(headerCentreX - headerNav.offsetWidth / 2, header.offsetWidth - headerNav.offsetWidth - 16, toCollapsed)}px`
        headerNav.style.top = `${lerp(120, 50 - headerNav.offsetHeight / 2, toCollapsed)}px`

        if (scrollAnim) {
            clearTimeout(scrollAnim)
            scrollAnim = null
        }
        if (mainMenu.scrollTop < 100) {
            let scrollTarget = toCollapsed < 0.5 ? 0 : 100
            scrollAnim = setTimeout(() => {
                mainMenu.scrollTo({
                    top: scrollTarget,
                    left: 0,
                    behavior: "smooth",
                })
            }, 200)
        }
    }
    mainMenu.addEventListener("scroll", calcHeaderPositioning)
    window.addEventListener("resize", calcHeaderPositioning)
    calcHeaderPositioning()

    function setMainMenuPage(pageName) {
        const page = mainMenu.querySelector(`.main-menu-page[data-page="${pageName}"]`)
        if (!page) return

        // data-page="main"
        headerNav.querySelector(".page-link-current")?.classList.remove("page-link-current")
        headerNav.querySelector(`a[data-page=${pageName}]`).classList.add("page-link-current")

        mainMenu.querySelectorAll(".main-menu-page").forEach(pageEl =>
            pageEl.style.display = "none")
        page.style.display = "flex"
    }
    function setHashPage(mainFallback = false) {
        const pages = ["main", "login", "signup", "profile", "settings"]
        const page = window.location.hash?.slice(1)
        if (pages.includes(page)) {
            setMainMenuPage(page)
        }
        else if (mainFallback) {
            setMainMenuPage("main")
        }
    }
    window.addEventListener("hashchange", (_) => setHashPage())
    setHashPage(true)
</script>
</body>
</html>
